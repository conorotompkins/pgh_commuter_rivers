---
title: "eda2"
author: "Conor Tompkins"
date: "11/15/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)
```
In my analysis I use many of the standard tidyverse packages, sf, tidygraph, and ggraph.
```{r}
library(tidyverse)
library(sf)
library(tigris)
library(tidycensus)
library(tidygraph)
library(ggraph)
```

```{r include=FALSE}
Sys.getenv("CENSUS_API_KEY")
options(tigris_use_cache = TRUE,
        readr.show_progress = FALSE)
```

The first step is to read in the geographies crosswalk and the census tract geographies.
```{r}
geo_crosswalk <- read_csv("data/pa_xwalk.csv.gz", col_types = cols(.default = "c"))

allegheny_tracts <- get_decennial(geography = "tract",
                           variables = c(total_pop = "P001001"),
                           state = "PA",
                           county = "Allegheny County",
                           geometry = TRUE,
                           output = "wide")

rivers <- st_read("data/USA_Rivers_and_Streams.shp") %>% 
  group_by(NAME) %>% 
  summarize() %>% 
  filter(!(str_detect(NAME,"Chartiers")))
rivers

rivers %>% 
  #filter(NAME == "Ohio River") %>% 
  ggplot() +
    geom_sf(aes(color = NAME), show.legend = FALSE) +
    geom_sf_label(aes(label = NAME, fill = NAME)) +
    theme_graph()
#st_difference(allegheny_tracts, rivers) %>% 
#  ggplot() +
#    geom_sf(fill = "black")

#allegheny_tracts <- st_erase(allegheny_water, allegheny_tracts)

```

This shows the outlines of the tracts used in the analysis.
```{r}
allegheny_tracts %>% 
  ggplot() +
    geom_sf()
```

The crosswalk file contains keys to join a variety of geographies.
```{r}
geo_crosswalk
```

Next I read in the main LODES data. This is a big file, so it takes a moment.
```{r}
df <- read_csv("data/pa_od_main_JT00_2015.csv.gz", col_types = cols(.default = "c")) %>% 
  mutate(S000 = as.numeric(S000)) %>% 
  select(h_geocode, w_geocode, S000)

df
```

Next I summarize the number of commuters per home-work tract combination. The original file uses census block codes, which are too granular for this analysis. I link the blocks to census tracts and aggregate to that level.
```{r}
df_tracts_summarized <- df %>% 
  group_by(h_geocode, w_geocode) %>% 
  summarize(commuters = sum(S000)) %>% 
  ungroup() %>% 
  arrange(desc(commuters))

df_tracts_summarized <- df_tracts_summarized %>% 
  left_join(geo_crosswalk %>% select(tabblk2010, trct), by = c("h_geocode" = "tabblk2010")) %>% 
  rename(h_tract = trct) %>% 
  left_join(geo_crosswalk %>% select(tabblk2010, trct), by = c("w_geocode" = "tabblk2010")) %>% 
  rename(w_tract = trct)

df_tracts_summarized <- df_tracts_summarized %>% 
  group_by(h_tract, w_tract) %>% 
  summarize(commuters = sum(commuters)) %>% 
  ungroup() %>% 
  arrange(desc(commuters))

df_tracts_summarized <- df_tracts_summarized %>% 
  semi_join(allegheny_tracts, by = c("h_tract" = "GEOID")) %>% 
  semi_join(allegheny_tracts, by = c("w_tract" = "GEOID"))
```

This code removes rows where the commuter lives and works in the same tract.
```{r}
df_tracts_summarized <- df_tracts_summarized %>% 
  arrange(h_tract) %>% 
  na.omit() %>% 
  filter(!(h_tract == w_tract))
```

This code finds the center of each tract, which I use as the nodes in the network plots.
```{r}
allegheny_tracts <- allegheny_tracts %>% 
  arrange(GEOID)

allegheny_tracts_centroids <- cbind(allegheny_tracts,
                                    st_coordinates(st_centroid(allegheny_tracts))) %>% 
  st_set_geometry(NULL) %>% 
  as_tibble() %>% 
  rename(x = X,
         y = Y) %>% 
  select(GEOID, x, y)
```

This shows that the centroids correctly appear in the center of each tract.
```{r}
allegheny_tracts %>% 
  ggplot() +
    geom_sf() +
    geom_point(data = allegheny_tracts_centroids, aes(x, y), size = .2) +
    geom_sf(data = rivers, aes(color = NAME))
```

```{r}
g <- df_tracts_summarized %>% 
  as_tbl_graph(directed = TRUE) %>% 
  activate(edges) %>% 
  filter(commuters > 100)

g
```

```{r}
node_pos <- allegheny_tracts_centroids

manual_layout <- create_layout(graph = g,
                               layout = node_pos)
```
```{r echo=FALSE}
manual_layout %>% 
  as_tibble()
```

```{r}
ggraph(manual_layout) +
  geom_sf(data = allegheny_tracts, color = "dark grey", fill = NA) +
  geom_sf(data = rivers, aes(color = NAME), show.legend = FALSE) +
  #geom_node_point(alpha = 0) +
  geom_edge_fan(aes(edge_width = commuters, 
                    edge_alpha = commuters),
                arrow = arrow(length = unit(.5, 'lines')), 
                start_cap = circle(.1, 'lines'),
                end_cap = circle(.2, 'lines'),
                color = "white",
                strength = .5) +
  scale_edge_width_continuous(range = c(.1, 1.5)) +
  scale_edge_alpha_continuous(range = c(.1, .8)) +
  #scale_fill_viridis_c() +
  labs(x = NULL,
       y = NULL,
       title = "Where do people commute from/to for work?",
       subtitle = "Excludes within-tract commuters",
       caption = "Based on 2015 US Census LODES dataset | @conor_tompkins") +
  theme_graph() +
  theme(legend.background = element_rect(fill = "light grey"),
        legend.text = element_text(color = "black"),
        legend.title = element_text(color = "black"),
        panel.background = element_rect(fill = "black"))
```

```{r}
allegheny_lines <- cbind(allegheny_tracts, st_coordinates(st_centroid(allegheny_tracts))) %>% 
  select(-c(NAME, total_pop)) %>% 
  st_drop_geometry()

allegheny_lines %>% 
  ggplot() +
    geom_point(aes(X, Y))
```

```{r}
df_edges <- g %>% 
  activate(edges) %>% 
  as_tibble()

df_nodes <- g %>% 
  activate(nodes) %>% 
  as_tibble() %>% 
  mutate(id = row_number())
```

```{r}
df_lines <- df_edges %>% 
  mutate(line_id = row_number()) %>% 
  pivot_longer(c(from, to), names_to = "point_type", values_to = "edge_id")

df_lines <- df_lines %>% 
  left_join(df_nodes, by = c("edge_id" = "id")) %>% 
  left_join(allegheny_lines, by = c("name" = "GEOID")) %>% 
  st_as_sf(coords = c("X", "Y")) %>% 
  group_by(line_id, commuters) %>%
  summarise() %>% # union points into lines using our created lineid
  st_cast("LINESTRING")
```

```{r}
df_lines <- df_lines %>% 
  st_set_crs(4326)

rivers <- rivers %>% 
  st_set_crs(4326)

df_lines
rivers
```

```{r}
df_lines %>% 
  ggplot() +
    geom_sf(aes(size = commuters,
                alpha = commuters)) +
    geom_sf(data = rivers,
            aes(color = NAME),
            size = 3) +
    scale_size_continuous(range = c(.1, 1)) +
    scale_alpha_continuous(range = c(.1, 1))
```
```{r}
#geom_sf is not accepting alpha as an aesthetic

df_lines <- df_lines %>% 
  ungroup() %>% 
  mutate(intersects_ohio = st_intersects(., rivers %>% 
                                            filter(NAME == "Ohio River")) %>% as.logical(),
         intersects_allegheny = st_intersects(., rivers %>% 
                                                filter(NAME == "Allegheny River")) %>% as.logical(),
         intersects_monongahela = st_intersects(., rivers %>% 
                                                  filter(NAME == "Monongahela River")) %>% as.logical())

df_commuter_rivers <- df_lines %>% 
  pivot_longer(c(contains("intersects")), names_to = "river_intersected", values_to = "value") %>% 
  mutate(value = case_when(is.na(value) ~ FALSE,
                           !is.na(value) ~ value))

df_commuter_rivers %>% 
  ggplot() +
    geom_sf(data = allegheny_tracts, color = NA, show.legend = FALSE) +
    geom_sf(data = rivers, show.legend = FALSE) +
    geom_sf(aes(geometry = geometry, 
                color = value,
                size = commuters),
            show.legend = TRUE) +
    facet_wrap(~river_intersected) +
    theme_graph() +
    scale_size_continuous(range = c(.1, .5))
```

```{r}
df_commuter_rivers_summary <- df_commuter_rivers %>% 
  group_by(line_id) %>% 
  summarize(rivers_crossed = sum(value),
            commuters = sum(commuters))

df_commuter_rivers_summary %>% 
  ggplot(aes(rivers_crossed, commuters)) +
    geom_jitter(width = .2) +
    theme_bw()
```

```{r}
#make chloropleth
df_lines_chloro <- df_edges %>% 
  mutate(line_id = row_number()) %>% 
  pivot_longer(c(from, to), names_to = "point_type", values_to = "edge_id")
df_lines_chloro
```  
```{r}
#  left_join(df_nodes %>% rename(from_name = name), by = c("from" = "id")) %>% 
#  left_join(df_nodes %>% rename(to_name = name), by = c("to" = "id")) %>% 
#  left_join(allegheny_lines %>% rename_all(~str_c("from_", .)), by = c("from_name" = "from_GEOID")) %>% 
#  left_join(allegheny_lines %>% rename_all(~str_c("to_", .)), by = c("to_name" = "to_GEOID"))
```
```{r}
#  pivot_longer(-c(line_id, commuters), names_to = c("edge_id", "geoid", "x_id", "y_id"), names_sep = "_")
  
  
#  pivot_longer(c(from, to), names_to = "edge_type", values_to = "edge_id") %>%
#  pivot_longer(c(from_name, to_name), names_to = "geoid_type", values_to = "geoid_name") %>% 
#  pivot_longer(c(from_X, to_X), names_to = "location_x_type", values_to = "location_x") %>% 
#  pivot_longer(c(from_Y, to_Y), names_to = "location_y_type", values_to = "location_y")

#df_lines_chloro
```
```{r}
df_lines_chloro <- df_lines_chloro %>% 
  left_join(df_nodes, by = c("edge_id" = "id")) %>% 
  left_join(allegheny_lines, by = c("name" = "GEOID"))

df_lines_chloro_wide <- df_lines_chloro %>% 
  select(line_id, point_type, name) %>% 
  pivot_wider(names_from = point_type, values_from = name)
```
```{r}
df_lines_chloro_line <- df_lines_chloro %>% 
  st_as_sf(coords = c("X", "Y")) %>% 
  group_by(line_id, commuters) %>%
  summarise() %>% # union points into lines using our created lineid
  st_cast("LINESTRING")

df_lines_chloro_line
```
```{r}
df_lines_chloro_line <- df_lines_chloro_line %>% 
  st_set_crs(4326)

rivers <- rivers %>% 
  st_set_crs(4326)
```

```{r}
df_chloro_wide <- df_lines_chloro_line %>% 
  ungroup() %>% 
  left_join(df_lines_chloro_wide) %>% 
  mutate(intersects_ohio = st_intersects(., rivers %>% 
                                            filter(NAME == "Ohio River")) %>% as.logical(),
         intersects_allegheny = st_intersects(., rivers %>% 
                                                filter(NAME == "Allegheny River")) %>% as.logical(),
         intersects_monongahela = st_intersects(., rivers %>% 
                                                  filter(NAME == "Monongahela River")) %>% as.logical()) %>% 
  st_set_geometry(NULL)

df_chloro_wide

df_chloro_wide <- df_chloro_wide %>% 
  pivot_longer(c(contains("intersects")), names_to = "river_intersected", values_to = "value") %>% 
  mutate(value = case_when(is.na(value) ~ FALSE,
                           !is.na(value) ~ value)) %>% 
  group_by(from, to, line_id, commuters) %>% 
  summarize(rivers_intersected = sum(value)) %>% 
  #arrange(desc(commuters_from)) %>% 
  right_join(allegheny_tracts, by = c("from" = "GEOID")) #%>% 
  #filter(!is.na(rivers_intersected))

test <- df_chloro_wide %>% 
  arrange(from, rivers_intersected, desc(commuters)) %>% 
  group_by(from) %>% 
  slice(1)
```
```{r}
test %>% 
  ggplot() +
    geom_sf(aes(geometry = geometry,
                fill = as.factor(rivers_intersected),
                alpha = commuters)) +
  scale_alpha_continuous(range = c(.8, 1)) +
  scale_fill_viridis_d()
```



