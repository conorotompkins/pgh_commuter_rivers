---
title: "eda2"
author: "Conor Tompkins"
date: "11/15/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)
```
In my analysis I use many of the standard tidyverse packages, sf, tidygraph, and ggraph.
```{r}
library(tidyverse)
library(sf)
library(tigris)
library(tidycensus)
library(tidygraph)
library(ggraph)
```

```{r include=FALSE}
Sys.getenv("CENSUS_API_KEY")
options(tigris_use_cache = TRUE,
        readr.show_progress = FALSE)
```

The first step is to read in the geographies crosswalk and the census tract geographies.
```{r}
geo_crosswalk <- read_csv("data/pa_xwalk.csv.gz", col_types = cols(.default = "c"))

allegheny_tracts <- get_decennial(geography = "tract",
                           variables = c(total_pop = "P001001"),
                           state = "PA",
                           county = "Allegheny County",
                           geometry = TRUE,
                           output = "wide")

rivers <- st_read("data/USA_Rivers_and_Streams.shp") %>% 
  group_by(NAME) %>% 
  summarize() %>% 
  filter(!(str_detect(NAME,"Chartiers")))
rivers

rivers %>% 
  #filter(NAME == "Ohio River") %>% 
  ggplot() +
    geom_sf(aes(color = NAME), show.legend = FALSE) +
    geom_sf_label(aes(label = NAME, fill = NAME)) +
    theme_graph()
#st_difference(allegheny_tracts, rivers) %>% 
#  ggplot() +
#    geom_sf(fill = "black")

#allegheny_tracts <- st_erase(allegheny_water, allegheny_tracts)

```

This shows the outlines of the tracts used in the analysis.
```{r}
allegheny_tracts %>% 
  ggplot() +
    geom_sf()
```

The crosswalk file contains keys to join a variety of geographies.
```{r}
geo_crosswalk
```

Next I read in the main LODES data. This is a big file, so it takes a moment.
```{r}
df <- read_csv("data/pa_od_main_JT00_2015.csv.gz", col_types = cols(.default = "c")) %>% 
  mutate(S000 = as.numeric(S000)) %>% 
  select(h_geocode, w_geocode, S000)

df
```

Next I summarize the number of commuters per home-work tract combination. The original file uses census block codes, which are too granular for this analysis. I link the blocks to census tracts and aggregate to that level.
```{r}
df_tracts_summarized <- df %>% 
  group_by(h_geocode, w_geocode) %>% 
  summarize(commuters = sum(S000)) %>% 
  ungroup() %>% 
  arrange(desc(commuters))

df_tracts_summarized <- df_tracts_summarized %>% 
  left_join(geo_crosswalk %>% select(tabblk2010, trct), by = c("h_geocode" = "tabblk2010")) %>% 
  rename(h_tract = trct) %>% 
  left_join(geo_crosswalk %>% select(tabblk2010, trct), by = c("w_geocode" = "tabblk2010")) %>% 
  rename(w_tract = trct)

df_tracts_summarized <- df_tracts_summarized %>% 
  group_by(h_tract, w_tract) %>% 
  summarize(commuters = sum(commuters)) %>% 
  ungroup() %>% 
  arrange(desc(commuters))

df_tracts_summarized <- df_tracts_summarized %>% 
  semi_join(allegheny_tracts, by = c("h_tract" = "GEOID")) %>% 
  semi_join(allegheny_tracts, by = c("w_tract" = "GEOID"))
```

This code removes rows where the commuter lives and works in the same tract.
```{r eval = FALSE}
df_tracts_summarized <- df_tracts_summarized %>% 
  arrange(h_tract) %>% 
  na.omit() %>% 
  filter(!(h_tract == w_tract))
```

This code finds the center of each tract, which I use as the nodes in the network plots.
```{r}
allegheny_tracts <- allegheny_tracts %>% 
  arrange(GEOID)

allegheny_tracts_centroids <- cbind(allegheny_tracts,
                                    st_coordinates(st_centroid(allegheny_tracts))) %>% 
  st_set_geometry(NULL) %>% 
  as_tibble() %>% 
  rename(x = X,
         y = Y) %>% 
  select(GEOID, x, y)
```

This shows that the centroids correctly appear in the center of each tract.
```{r}
allegheny_tracts %>% 
  ggplot() +
    geom_sf() +
    geom_point(data = allegheny_tracts_centroids, aes(x, y), size = .2) +
    geom_sf(data = rivers, aes(color = NAME))
```

```{r}
g <- df_tracts_summarized %>% 
  as_tbl_graph(directed = TRUE) %>% 
  activate(edges) %>% 
  filter(commuters > 25)

g
```

```{r}
node_pos <- allegheny_tracts_centroids

manual_layout <- create_layout(graph = g,
                               layout = node_pos)
```
```{r echo=FALSE}
manual_layout %>% 
  as_tibble()
```

```{r}
ggraph(manual_layout) +
  geom_sf(data = allegheny_tracts, color = "dark grey", fill = NA) +
  geom_sf(data = rivers, aes(color = NAME), show.legend = FALSE) +
  #geom_node_point(alpha = 0) +
  geom_edge_fan(aes(edge_width = commuters, 
                    edge_alpha = commuters),
                arrow = arrow(length = unit(.5, 'lines')), 
                start_cap = circle(.1, 'lines'),
                end_cap = circle(.2, 'lines'),
                color = "white",
                strength = .5) +
  scale_edge_width_continuous(range = c(.1, 1.5)) +
  scale_edge_alpha_continuous(range = c(.1, .5)) +
  #scale_fill_viridis_c() +
  labs(x = NULL,
       y = NULL,
       title = "Where do people commute from/to for work?",
       subtitle = "Excludes within-tract commuters",
       caption = "Based on 2015 US Census LODES dataset | @conor_tompkins") +
  theme_graph() +
  theme(legend.background = element_rect(fill = "light grey"),
        legend.text = element_text(color = "black"),
        legend.title = element_text(color = "black"),
        panel.background = element_rect(fill = "black"))
```

```{r}
allegheny_lines <- cbind(allegheny_tracts, st_coordinates(st_centroid(allegheny_tracts))) %>% 
  select(-c(NAME, total_pop)) %>% 
  st_drop_geometry()

allegheny_lines %>% 
  ggplot() +
    geom_point(aes(X, Y))
```

```{r}
df_edges <- g %>% 
  activate(edges) %>% 
  as_tibble()

df_nodes <- g %>% 
  activate(nodes) %>% 
  as_tibble() %>% 
  mutate(id = row_number())
```

```{r}
df_lines <- df_edges %>% 
  mutate(line_id = row_number()) %>% 
  pivot_longer(c(from, to), names_to = "point_type", values_to = "edge_id")

df_lines
```
```{r}
df_line_types <- df_lines %>% 
  #select(line_id, point_type, edge_id) %>% 
  pivot_wider(names_from = point_type, values_from = edge_id) %>% 
  mutate(line_type = case_when(from == to ~ "point",
                               from != to ~ "linestring")) %>% 
  pivot_longer(cols = c(from, to), names_to = "edge_type", values_to = "edge_id")
df_line_types
```

```{r}
df_linestrings <- df_line_types %>% 
  filter(line_type == "linestring")

df_points <- df_line_types %>% 
  filter(line_type == "point")
```

```{r}
df_linestrings <- df_linestrings %>% 
  left_join(df_nodes, by = c("edge_id" = "id")) %>% 
  left_join(allegheny_lines, by = c("name" = "GEOID")) %>% 
  st_as_sf(coords = c("X", "Y")) %>% 
  group_by(line_id, commuters) %>%
  summarise() %>% # union points into lines using our created lineid
  st_cast("LINESTRING") %>% 
  st_set_crs(4326)

df_points <- df_points %>% 
  left_join(df_nodes, by = c("edge_id" = "id")) %>% 
  left_join(allegheny_lines, by = c("name" = "GEOID")) %>% 
  st_as_sf(coords = c("X", "Y")) %>% 
  group_by(line_id, commuters) %>%
  summarise() %>% # union points into lines using our created lineid
  st_cast("POINT") %>% 
  st_set_crs(4326)
```

```{r}
rivers <- rivers %>% 
  st_set_crs(4326)

rivers
```

```{r}
df_linestrings %>% 
  ggplot() +
    geom_sf() +
    geom_sf(data = df_points, color = "red")


df_linestrings %>% 
  ggplot() +
    geom_sf(aes(size = commuters,
                alpha = commuters)) +
    geom_sf(data = df_points, color = "red") +
    geom_sf(data = rivers,
            aes(color = NAME),
            size = 3) +
    scale_size_continuous(range = c(.1, 1)) +
    scale_alpha_continuous(range = c(.1, 1)) +
    theme_void()
```
```{r}
#geom_sf is not accepting alpha as an aesthetic

df_linestrings_intersect <- df_linestrings %>% 
  ungroup() %>% 
  mutate(intersects_ohio = st_intersects(., rivers %>% 
                                            filter(NAME == "Ohio River")) %>% as.logical(),
         intersects_allegheny = st_intersects(., rivers %>% 
                                                filter(NAME == "Allegheny River")) %>% as.logical(),
         intersects_monongahela = st_intersects(., rivers %>% 
                                                  filter(NAME == "Monongahela River")) %>% as.logical())

df_commuter_rivers <- df_linestrings_intersect %>% 
  pivot_longer(c(contains("intersects")), names_to = "river_intersected", values_to = "value") %>% 
  mutate(value = case_when(is.na(value) ~ FALSE,
                           !is.na(value) ~ value))

df_commuter_rivers %>% 
  filter(value == TRUE) %>% 
  ggplot() +
    geom_sf(data = allegheny_tracts, color = NA, show.legend = FALSE) +
    geom_sf(data = rivers, show.legend = FALSE) +
    geom_sf(aes(geometry = geometry, 
                color = value,
                size = commuters),
            #alpha = .1,
            show.legend = TRUE) +
    facet_wrap(~river_intersected) +
    theme_graph() +
    scale_size_continuous(range = c(.1, .1))
```

```{r}
df_commuter_rivers_summary <- df_commuter_rivers %>% 
  group_by(line_id) %>% 
  summarize(rivers_crossed = sum(value),
            commuters = sum(commuters))

df_commuter_rivers_summary %>% 
  ggplot(aes(rivers_crossed, commuters)) +
    geom_jitter(width = .2) +
    theme_bw()
```

## Chloropleth

```{r}
#make chloropleth
df_lines_chloro <- df_edges %>% 
  mutate(line_id = row_number()) %>% 
  pivot_longer(c(from, to), names_to = "point_type", values_to = "edge_id")
df_lines_chloro
```  
```{r}
#  left_join(df_nodes %>% rename(from_name = name), by = c("from" = "id")) %>% 
#  left_join(df_nodes %>% rename(to_name = name), by = c("to" = "id")) %>% 
#  left_join(allegheny_lines %>% rename_all(~str_c("from_", .)), by = c("from_name" = "from_GEOID")) %>% 
#  left_join(allegheny_lines %>% rename_all(~str_c("to_", .)), by = c("to_name" = "to_GEOID"))
```
```{r}
#  pivot_longer(-c(line_id, commuters), names_to = c("edge_id", "geoid", "x_id", "y_id"), names_sep = "_")
  
  
#  pivot_longer(c(from, to), names_to = "edge_type", values_to = "edge_id") %>%
#  pivot_longer(c(from_name, to_name), names_to = "geoid_type", values_to = "geoid_name") %>% 
#  pivot_longer(c(from_X, to_X), names_to = "location_x_type", values_to = "location_x") %>% 
#  pivot_longer(c(from_Y, to_Y), names_to = "location_y_type", values_to = "location_y")

#df_lines_chloro
```
```{r}
#df_lines_chloro <- df_lines_chloro %>% 
#  left_join(df_nodes, by = c("edge_id" = "id")) %>% 
#  left_join(allegheny_lines, by = c("name" = "GEOID"))

#df_lines_chloro
```
```{r}
df_line_types_chloro <- df_lines_chloro %>% 
  #select(line_id, point_type, edge_id) %>% 
  pivot_wider(names_from = point_type, values_from = edge_id) %>% 
  mutate(line_type = case_when(from == to ~ "point",
                               from != to ~ "linestring")) %>% 
  pivot_longer(cols = c(from, to), names_to = "edge_type", values_to = "edge_id")
  
df_line_types_chloro
```

```{r}
df_linestrings_chloro <- df_line_types_chloro %>% 
  filter(line_type == "linestring")

df_linestrings_chloro_lookup <- df_linestrings_chloro %>% 
  select(line_id, edge_type, edge_id) %>% 
  pivot_wider(names_from = edge_type, values_from = edge_id)

df_points_chloro <- df_line_types %>% 
  filter(line_type == "point")
```

```{r}
df_linestrings_chloro <- df_linestrings_chloro %>% 
  left_join(df_nodes, by = c("edge_id" = "id")) %>% 
  left_join(allegheny_lines, by = c("name" = "GEOID")) %>% 
  st_as_sf(coords = c("X", "Y")) %>% 
  group_by(line_id, commuters) %>%
  summarise() %>% # union points into lines using our created lineid
  st_cast("LINESTRING") %>% 
  st_set_crs(4326) %>% 
  left_join(df_linestrings_chloro_lookup, by = c("line_id" = "line_id")) %>% 
  left_join(df_nodes, by = c("from" = "id")) %>% 
  left_join(allegheny_lines, by = c("name" = "GEOID"))

df_points_chloro <- df_points_chloro %>% 
  left_join(df_nodes, by = c("edge_id" = "id")) %>% 
  left_join(allegheny_lines, by = c("name" = "GEOID")) %>% 
  st_as_sf(coords = c("X", "Y")) %>% 
  group_by(line_id, name, commuters) %>%
  summarise() %>% # union points into lines using our created lineid
  st_cast("POINT") %>% 
  st_set_crs(4326)
```

```{r}
#df_lines_chloro_wide <- df_lines_chloro %>% 
#  select(line_id, point_type, name) %>% 
#  pivot_wider(names_from = point_type, values_from = name)

#df_lines_chloro_wide
```
```{r}
#df_lines_chloro_line <- df_lines_chloro %>% 
#  st_as_sf(coords = c("X", "Y")) %>% 
#  group_by(line_id, commuters) %>%
#  summarise() %>% # union points into lines using our created lineid
#  st_cast("LINESTRING")

#df_lines_chloro_line
```
```{r}
rivers <- rivers %>% 
  st_set_crs(4326)
```

```{r}
df_linestrings_chloro %>% 
  ggplot() +
    geom_sf()

df_points_chloro %>% 
   ggplot() +
    geom_sf()
```

```{r}
df_linestrings_chloro_intersect <- df_linestrings_chloro %>% 
  ungroup() %>% 
  #left_join(df_lines_chloro_wide) %>% 
  mutate(intersects_ohio = st_intersects(., rivers %>% 
                                            filter(NAME == "Ohio River")) %>% as.logical(),
         intersects_allegheny = st_intersects(., rivers %>% 
                                                filter(NAME == "Allegheny River")) %>% as.logical(),
         intersects_monongahela = st_intersects(., rivers %>% 
                                                  filter(NAME == "Monongahela River")) %>% as.logical()) %>% 
  st_set_geometry(NULL) %>% 
  select(-c(from, to)) %>% 
  rename(from = name)

df_linestrings_chloro_intersect
```

```{r}
df_linestrings_chloro_intersect <- df_linestrings_chloro_intersect %>% 
  mutate_at(vars(contains("intersect")), ~case_when(is.na(.) ~ FALSE,
                           !is.na(.) ~ .)) %>%
  mutate(no_intersect = case_when(intersects_allegheny == FALSE & intersects_monongahela == FALSE & intersects_ohio == FALSE ~ TRUE,
                                  TRUE ~ FALSE)) %>% 
  select(line_id, from, 
         #to, 
         contains("intersect"), commuters) %>% 
  pivot_longer(contains("intersect"), names_to = "river_intersected", values_to = "value")

df_linestrings_chloro_intersect
```

```{r}
df_linestrings_chloro_intersect <- df_linestrings_chloro_intersect %>% 
  mutate(commuters = case_when(value == FALSE ~ 0,
                               TRUE ~ commuters))

df_linestrings_chloro_intersect
```

```{r}
df_linestrings_chloro_intersect %>% 
  filter(value == TRUE) %>% 
  add_count(line_id, name = "count_line_id", sort = TRUE)
```
```{r}
df_linestrings_chloro_intersect <- df_linestrings_chloro_intersect %>% 
  filter(value == TRUE) %>% 
  group_by(line_id, from, 
           #to, 
           commuters) %>% 
  summarize(count_rivers_intersected = sum(river_intersected != "no_intersect"))

df_linestrings_chloro_intersect
```

```{r}
df_points_chloro <- cbind(df_points_chloro, st_coordinates(st_centroid(df_points_chloro))) %>% 
  st_drop_geometry() %>% 
  rename(from = name) %>% 
  select(line_id, from, commuters) %>% 
  mutate(count_rivers_intersected = 0)

df_points_chloro
```

```{r}
df_combined <- bind_rows(df_linestrings_chloro_intersect, df_points_chloro)

df_combined
```

```{r}
df_combined %>% 
  ggplot(aes(count_rivers_intersected, commuters)) +
    geom_jitter(width = .2, 
                height = .2,
                alpha = .5) +
    scale_x_continuous(breaks = c(0:3)) +
    theme_bw()
```

```{r}
df_combined <- df_combined %>% 
  arrange(from, desc(count_rivers_intersected), desc(commuters))
```
```{r}
df_combined %>% 
  right_join(allegheny_tracts, by = c("from" = "GEOID")) %>% 
  ggplot() +
    geom_sf(aes(geometry = geometry,
                fill = as.factor(count_rivers_intersected),
                alpha = commuters)) +
  geom_sf(data = rivers,
          aes(color = NAME),
          size = 2) +
  scale_alpha_continuous(range = c(.8, 1)) +
  scale_fill_viridis_d() +
  theme_void()
```

```{r}
test <- df_combined %>%
  ungroup() %>% 
  group_by(from, count_rivers_intersected) %>% 
  summarize(total_commuters = sum(commuters)) %>% 
  ungroup %>% 
  group_by(from) %>% 
  mutate(pct_of_commuters = total_commuters / sum(total_commuters)) %>% 
  ungroup() %>% 
  right_join(allegheny_tracts %>% select(GEOID) %>% st_set_geometry(NULL), by = c("from" = "GEOID")) %>% 
  complete(from, count_rivers_intersected = c(0, 1, 2)) %>%
  filter(!is.na(count_rivers_intersected)) %>% 
  replace_na(list(pct_of_commuters = 0, total_commuters = 0)) %>% 
  right_join(allegheny_tracts, by = c("from" = "GEOID"))
  
test %>% 
  mutate(count_rivers_intersected = str_c("Rivers intersected:", count_rivers_intersected, sep = " ")) %>% 
  ggplot() +
    geom_sf(aes(geometry = geometry,
                fill = pct_of_commuters),
            color = NA) +
    geom_sf(data = rivers,
            aes(color = NAME),
            size = 2,
            show.legend = FALSE) +
    facet_wrap(~count_rivers_intersected) +
    scale_fill_viridis_c() +
    theme_void()
```



